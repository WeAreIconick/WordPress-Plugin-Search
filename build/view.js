(()=>{document.addEventListener("DOMContentLoaded",function(){console.log("DOM loaded, looking for plugin search blocks...");const t=document.querySelectorAll(".wp-block-telex-block-wordpress-plugin-search");if(console.log(`Found ${t.length} blocks with .wp-block-telex-block-wordpress-plugin-search`),0===t.length){const t=document.querySelectorAll(".wps-search-block");console.log(`Found ${t.length} blocks with .wps-search-block`),t.forEach(t=>{console.log("Initializing alt block:",t),new e(t)})}else t.forEach(t=>{console.log("Initializing main block:",t),new e(t)})});class e{constructor(e){this.block=e,this.cache=new Map,this.currentRequest=null,this.searchTimeout=null,this.restNonce=window.wpApiSettings?.nonce||"",this.attributes=this.getBlockAttributes(),this.state={searchTerm:this.sanitizeInput(this.attributes.searchTerm||""),currentPage:1,resultsPerPage:Math.max(1,Math.min(100,parseInt(this.attributes.resultsPerPage)||12)),sortBy:this.attributes.defaultSort||"popular",category:"all",minRating:0,maxInstalls:null,updatedWithin:"any",onlyWithScreenshots:!1,isLoading:!1,plugins:[],allPlugins:[],totalResults:0,showFilters:!1!==this.attributes.showFilters,hasMorePages:!1,isLoadingMore:!1,screenshotCache:new Map},this.categories={all:"All Categories",accessibility:"Accessibility",admin:"Admin",commerce:"E-Commerce",forms:"Forms",media:"Media",performance:"Performance",security:"Security",seo:"SEO",social:"Social",widgets:"Widgets"},this.lightbox={element:null,isOpen:!1,currentPlugin:null,currentIndex:0,screenshots:[]},this.init()}decodeHtmlEntities(e){return"string"!=typeof e?e:(new DOMParser).parseFromString(`<!doctype html><body>${e}`,"text/html").body.textContent||""}sanitizeInput(e){return"string"!=typeof e?"":e.replace(/<[^>]*>/g,"").replace(/[<>"'&]/g,function(e){return{"<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","&":"&amp;"}[e]}).trim()}sanitizeAndDecodeText(e){if("string"!=typeof e)return"";let t=this.decodeHtmlEntities(e);return t=t.replace(/<[^>]*>/g,""),t.trim()}getBlockAttributes(){const e=this.block.dataset;return{searchTerm:this.sanitizeInput(e.searchTerm||""),resultsPerPage:Math.max(1,Math.min(100,parseInt(e.resultsPerPage)||12)),defaultSort:e.defaultSort||"popular",showFilters:"false"!==e.showFilters}}async init(){try{this.renderInterface(),this.createLightboxHTML(),this.bindEvents(),await this.performSearch()}catch(e){this.renderError("Failed to initialize search interface.")}}createElement(e,t={},s=""){const i=document.createElement(e);for(const[e,s]of Object.entries(t))"string"!=typeof s&&"number"!=typeof s||i.setAttribute(e,s);return s&&(i.textContent=s),i}createButton(e,t,s=""){const i=this.createElement("div",{class:"wp-block-button"}),n=this.createElement("a",{class:`wp-block-button__link wp-element-button ${s}`.trim(),tabindex:"0",role:"button"},e);return n.addEventListener("click",e=>{e.preventDefault(),t(e)}),n.addEventListener("keydown",e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),t(e))}),i.appendChild(n),{container:i,link:n}}createLightboxHTML(){const e=document.querySelector(".wps-lightbox");e&&e.remove();const t=this.createElement("div",{class:"wps-lightbox",style:"display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.9); z-index: 999999; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box;"}),s=this.createElement("div",{class:"wps-lightbox-content",style:"position: relative; max-width: 90vw; max-height: 90vh; background: white; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column;"}),i=this.createElement("div",{class:"wps-lightbox-header",style:"padding: 1rem 1.5rem; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; background: #f8f9fa;"}),n=this.createElement("h3",{class:"wps-lightbox-title",style:"margin: 0; font-size: 1.2rem; color: #333; flex: 1;"}),l=this.createElement("button",{class:"wps-lightbox-close",style:"background: none; border: none; font-size: 24px; cursor: pointer; padding: 8px; border-radius: 4px; color: #666; z-index: 100; position: relative;","aria-label":"Close lightbox"},"×");i.appendChild(n),i.appendChild(l);const a=this.createElement("div",{class:"wps-lightbox-image-container",style:"flex: 1; display: flex; align-items: center; justify-content: center; position: relative; background: #f8f9fa; padding: 2rem; min-height: 400px;"}),r=this.createElement("img",{class:"wps-lightbox-image",style:"max-width: 100%; max-height: 100%; object-fit: contain; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border-radius: 4px;"}),o=this.createElement("button",{class:"wps-lightbox-prev",style:"position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.6); color: white; border: none; border-radius: 50%; width: 50px; height: 50px; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 10;","aria-label":"Previous image"},"‹"),h=this.createElement("button",{class:"wps-lightbox-next",style:"position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.6); color: white; border: none; border-radius: 50%; width: 50px; height: 50px; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 10;","aria-label":"Next image"},"›");a.appendChild(r),a.appendChild(o),a.appendChild(h);const c=this.createElement("div",{class:"wps-lightbox-footer",style:"padding: 1rem; text-align: center; background: white; border-top: 1px solid #e0e0e0; font-size: 0.9rem; color: #666;"});s.appendChild(i),s.appendChild(a),s.appendChild(c),t.appendChild(s),document.body.appendChild(t),this.lightbox.element=t,this.lightbox.title=n,this.lightbox.image=r,this.lightbox.footer=c,this.lightbox.closeButton=l,this.lightbox.prevButton=o,this.lightbox.nextButton=h,this.bindLightboxEvents()}bindLightboxEvents(){if(this.lightbox.element)try{this.lightbox.closeButton.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),this.closeLightbox()}),this.lightbox.prevButton.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),this.navigateLightbox(-1)}),this.lightbox.nextButton.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),this.navigateLightbox(1)}),this.lightbox.element.addEventListener("click",e=>{e.target===this.lightbox.element&&this.closeLightbox()}),document.addEventListener("keydown",e=>{if(this.lightbox.isOpen)switch(e.key){case"Escape":e.preventDefault(),this.closeLightbox();break;case"ArrowLeft":e.preventDefault(),this.navigateLightbox(-1);break;case"ArrowRight":e.preventDefault(),this.navigateLightbox(1)}})}catch(e){}else console.error("Lightbox element not found for event binding")}openLightbox(e,t=0){if(this.lightbox.element)if(e&&e.screenshots&&0!==e.screenshots.length)try{this.lightbox.isOpen=!0,this.lightbox.currentPlugin=e,this.lightbox.screenshots=e.screenshots,this.lightbox.currentIndex=Math.max(0,Math.min(t,e.screenshots.length-1));const s=this.sanitizeAndDecodeText(e.name||"Plugin");this.lightbox.title.textContent=s,this.updateLightboxImage(),this.lightbox.element.style.display="flex",document.body.style.overflow="hidden",setTimeout(()=>{this.lightbox.closeButton?.focus()},100)}catch(e){}else console.warn("Plugin has no screenshots")}closeLightbox(){if(this.lightbox.element&&this.lightbox.isOpen)try{this.lightbox.isOpen=!1,this.lightbox.currentPlugin=null,this.lightbox.screenshots=[],this.lightbox.element.style.display="none",document.body.style.overflow=""}catch(e){}}navigateLightbox(e){!this.lightbox.isOpen||!this.lightbox.screenshots||this.lightbox.screenshots.length<=1||(this.lightbox.currentIndex+=e,this.lightbox.currentIndex<0?this.lightbox.currentIndex=this.lightbox.screenshots.length-1:this.lightbox.currentIndex>=this.lightbox.screenshots.length&&(this.lightbox.currentIndex=0),this.updateLightboxImage())}updateLightboxImage(){if(this.lightbox.screenshots&&0!==this.lightbox.screenshots.length)try{const e=this.lightbox.screenshots[this.lightbox.currentIndex],t=this.sanitizeAndDecodeText(this.lightbox.currentPlugin?.name||"Plugin");this.lightbox.image.src=e.url,this.lightbox.image.alt=`${t} screenshot ${this.lightbox.currentIndex+1}`,this.lightbox.footer.textContent=`${this.lightbox.currentIndex+1} / ${this.lightbox.screenshots.length}`,this.lightbox.screenshots.length<=1?(this.lightbox.prevButton.style.display="none",this.lightbox.nextButton.style.display="none"):(this.lightbox.prevButton.style.display="flex",this.lightbox.nextButton.style.display="flex")}catch(e){console.error("Error updating lightbox image:",e)}}renderInterface(){this.block.innerHTML="";const e=this.createElement("div",{class:"wps-search-interface"}),t=this.createElement("div",{class:"wps-search-block__header"});t.appendChild(this.createElement("h2",{class:"wps-search-block__title"},"WordPress Plugin Search")),t.appendChild(this.createElement("p",{class:"wps-search-block__description"},"Search and discover plugins with advanced sorting and filtering."));const s=this.createElement("div",{class:"wps-search-block__controls"}),i=this.createElement("div",{class:"wps-search-input"}),n=this.createElement("input",{type:"search",placeholder:"Search plugins...",value:this.state.searchTerm}),l=this.createButton("Search",()=>{this.state.searchTerm=this.sanitizeInput(this.elements.searchInput.value),this.state.currentPage=1,this.state.plugins=[],this.performSearch()});if(i.appendChild(n),i.appendChild(l.container),s.appendChild(i),this.state.showFilters){const e=this.createElement("div",{class:"wps-filter-controls"}),t=this.createElement("div",{class:"wps-filter-row"}),i=this.createElement("div",{class:"wps-filter-item"});i.appendChild(this.createElement("label",{},"Sort by"));const n=this.createElement("select",{class:"components-select-control__input"});[{value:"popular",label:"Most Popular"},{value:"rating",label:"Highest Rated"},{value:"installs",label:"Most Installs"},{value:"updated",label:"Recently Updated"},{value:"newest",label:"Newest"}].forEach(e=>{const t=this.createElement("option",{value:e.value},e.label);e.value===this.state.sortBy&&(t.selected=!0),n.appendChild(t)}),i.appendChild(n),t.appendChild(i);const l=this.createElement("div",{class:"wps-filter-item"});l.appendChild(this.createElement("label",{},"Category"));const a=this.createElement("select",{class:"components-select-control__input"});Object.entries(this.categories).forEach(([e,t])=>{const s=this.createElement("option",{value:e},t);e===this.state.category&&(s.selected=!0),a.appendChild(s)}),l.appendChild(a),t.appendChild(l);const r=this.createElement("div",{class:"wps-filter-item"});r.appendChild(this.createElement("label",{},"Min Rating"));const o=this.createElement("select",{class:"components-select-control__input"});[{value:0,label:"Any Rating"},{value:80,label:"4+ Stars"},{value:60,label:"3+ Stars"},{value:40,label:"2+ Stars"}].forEach(e=>{const t=this.createElement("option",{value:e.value},e.label);e.value===this.state.minRating&&(t.selected=!0),o.appendChild(t)}),r.appendChild(o),t.appendChild(r);const h=this.createElement("div",{class:"wps-filter-item"});h.appendChild(this.createElement("label",{},"Max Installs"));const c=this.createElement("select",{class:"components-select-control__input"});[{value:null,label:"Any Amount"},{value:1e3,label:"Under 1K (Hidden Gems)"},{value:1e4,label:"Under 10K"},{value:1e5,label:"Under 100K"},{value:1e6,label:"Under 1M"}].forEach(e=>{const t=this.createElement("option",{value:e.value||""},e.label);e.value===this.state.maxInstalls&&(t.selected=!0),c.appendChild(t)}),h.appendChild(c),t.appendChild(h),e.appendChild(t);const d=this.createElement("div",{class:"wps-filter-toggles"}),p=this.createElement("div",{class:"wps-toggle-item"}),g=this.createElement("input",{type:"checkbox",id:"wps-screenshots-only"});g.checked=this.state.onlyWithScreenshots;const u=this.createElement("label",{for:"wps-screenshots-only"},"Only show plugins with screenshots");p.appendChild(g),p.appendChild(u),d.appendChild(p),e.appendChild(d),s.appendChild(e),this.filterElements={sortSelect:n,categorySelect:a,ratingSelect:o,installsSelect:c,screenshotsCheckbox:g}}const a=this.createElement("div",{class:"wps-results-info",style:"display: none;"}),r=this.createElement("span",{class:"wps-results-count"}),o=this.createButton("Clear Filters",()=>this.clearAllFilters());a.appendChild(r),a.appendChild(o.container);const h=this.createElement("div",{class:"wps-search-block__results"}),c=this.createElement("div",{class:"wps-plugin-grid"}),d=this.createElement("div",{class:"wps-loading",style:"display: none;"});d.appendChild(this.createElement("div",{class:"wps-spinner"})),d.appendChild(this.createElement("p",{},"Searching plugins...")),h.appendChild(c),h.appendChild(d);const p=this.createElement("div",{class:"wps-load-more-container",style:"display: none;"}),g=this.createButton("Load More Plugins",()=>this.loadMorePlugins()),u=this.createElement("div",{class:"wps-load-more-spinner",style:"display: none;"});u.appendChild(this.createElement("div",{class:"wps-spinner"})),u.appendChild(this.createElement("span",{},"Loading more...")),p.appendChild(g.container),p.appendChild(u);const m=this.createElement("div",{class:"wps-pagination"});e.appendChild(t),e.appendChild(s),e.appendChild(a),e.appendChild(h),e.appendChild(p),e.appendChild(m),this.block.appendChild(e),this.elements={searchInput:n,searchButton:l.link,resultsInfo:a,resultsCount:r,clearFilters:o.link,grid:c,loading:d,pagination:m,loadMoreContainer:p,loadMoreButton:g.link,loadMoreSpinner:u}}bindEvents(){this.elements.searchInput.addEventListener("input",e=>{clearTimeout(this.searchTimeout),this.searchTimeout=setTimeout(()=>{this.state.searchTerm=this.sanitizeInput(e.target.value),this.state.currentPage=1,this.state.plugins=[],this.performSearch()},300)}),this.elements.searchInput.addEventListener("keypress",e=>{"Enter"===e.key&&(e.preventDefault(),this.state.searchTerm=this.sanitizeInput(e.target.value),this.state.currentPage=1,this.state.plugins=[],this.performSearch())}),this.filterElements&&(this.filterElements.sortSelect.addEventListener("change",e=>{this.state.sortBy=e.target.value,this.state.currentPage=1,this.state.plugins=[],this.performSearch()}),this.filterElements.categorySelect.addEventListener("change",e=>{this.state.category=e.target.value,this.state.currentPage=1,this.state.plugins=[],this.performSearch()}),this.filterElements.ratingSelect.addEventListener("change",e=>{this.state.minRating=parseInt(e.target.value),this.state.currentPage=1,this.state.plugins=[],this.performSearch()}),this.filterElements.installsSelect.addEventListener("change",e=>{this.state.maxInstalls=e.target.value?parseInt(e.target.value):null,this.state.currentPage=1,this.state.plugins=[],this.performSearch()}),this.filterElements.screenshotsCheckbox.addEventListener("change",async e=>{this.state.onlyWithScreenshots=e.target.checked,this.state.onlyWithScreenshots&&this.state.plugins.length>0?(this.setLoading(!0),await this.applyScreenshotFilter(),this.renderResults(),this.updateResultsInfo(),this.setLoading(!1)):this.state.onlyWithScreenshots||(this.state.currentPage=1,this.state.plugins=[],this.performSearch())}))}async loadMorePlugins(){if(this.state.hasMorePages&&!this.state.isLoadingMore){this.state.currentPage++,this.state.isLoadingMore=!0,this.elements.loadMoreButton.parentNode.style.display="none",this.elements.loadMoreSpinner.style.display="flex";try{await this.performSearch(!0)}catch(e){console.error("Error loading more plugins:",e),this.elements.loadMoreSpinner.style.display="none",this.elements.loadMoreButton.parentNode.style.display="inline-block",this.elements.loadMoreButton.textContent="Try Loading More"}finally{this.state.isLoadingMore=!1}}}clearAllFilters(){this.state.searchTerm="",this.state.sortBy=this.attributes.defaultSort||"popular",this.state.category="all",this.state.minRating=0,this.state.maxInstalls=null,this.state.onlyWithScreenshots=!1,this.state.currentPage=1,this.state.plugins=[],this.elements.searchInput.value="",this.filterElements&&(this.filterElements.sortSelect.value=this.state.sortBy,this.filterElements.categorySelect.value=this.state.category,this.filterElements.ratingSelect.value=this.state.minRating,this.filterElements.installsSelect.value="",this.filterElements.screenshotsCheckbox.checked=this.state.onlyWithScreenshots),this.performSearch()}async performSearch(e=!1){this.currentRequest&&this.currentRequest.abort(),e||this.setLoading(!0);const t={action:"query_plugins",per_page:this.state.onlyWithScreenshots?Math.min(100,3*this.state.resultsPerPage).toString():this.state.resultsPerPage.toString(),page:this.state.currentPage.toString()};if(console.log("WordPress Plugin Search: Search params:",t),console.log("Building search params:",t),this.state.searchTerm&&(t.search=this.state.searchTerm),"newest"===this.state.sortBy?t.browse="new":"updated"===this.state.sortBy?t.browse="updated":t.browse="popular","all"!==this.state.category){const e=this.state.category;this.state.searchTerm?t.search=`${this.state.searchTerm} ${e}`:t.search=e}console.log("Final search params:",t);try{this.currentRequest=new AbortController;const s=new URL("/wp-json/wordpress-plugin-search/v1/query",window.location.origin);Object.entries(t).forEach(([e,t])=>{s.searchParams.set(e,t)}),console.log("WordPress Plugin Search: Final URL:",s.toString());const i=await fetch(s.toString(),{headers:{"Content-Type":"application/json",...this.restNonce&&{"X-WP-Nonce":this.restNonce}},signal:this.currentRequest.signal,credentials:"same-origin"});if(!i.ok)throw new Error(`HTTP ${i.status}`);const n=await i.json();if(console.log("API Response:",n),!n||"object"!=typeof n)throw new Error("Invalid response format from server");let l=Array.isArray(n.plugins)?n.plugins:[];this.state.totalResults=parseInt(n.info?.results)||0,console.log(`Found ${l.length} plugins, total results: ${this.state.totalResults}`);const a=Math.ceil(this.state.totalResults/this.state.resultsPerPage);if(this.state.hasMorePages=this.state.currentPage<a,this.addScreenshotUrls(l),l=this.applyClientFilters(l),this.state.onlyWithScreenshots&&(l=await this.filterPluginsWithScreenshots(l)),e&&this.state.plugins.length>0){const e=new Set(this.state.plugins.map(e=>e.slug)),t=l.filter(t=>!e.has(t.slug));this.state.plugins=[...this.state.plugins,...t]}else this.state.plugins=l;this.renderResults(e),this.updateLoadMoreButton(),this.updateResultsInfo()}catch(t){if("AbortError"!==t.name){console.error("Search error:",t);let s="Failed to search plugins.";t.message.includes("HTTP 503")?s="WordPress.org plugin directory is temporarily unavailable. Please try again later.":t.message.includes("HTTP 502")?s="Unable to connect to plugin directory. Please check your internet connection.":t.message.includes("HTTP 404")?s="Search service not found. Please refresh the page and try again.":"TypeError"===t.name&&t.message.includes("fetch")&&(s="Network error. Please check your internet connection."),e||this.renderError(s)}}finally{e||this.setLoading(!1),this.currentRequest=null,this.elements.loadMoreSpinner.style.display="none"}}applyClientFilters(e){let t=[...e];return this.state.minRating>0&&(t=t.filter(e=>e.rating&&e.rating>=this.state.minRating)),this.state.maxInstalls&&(t=t.filter(e=>!e.active_installs||e.active_installs<=this.state.maxInstalls)),"rating"===this.state.sortBy?t.sort((e,t)=>(t.rating||0)-(e.rating||0)):"installs"===this.state.sortBy&&t.sort((e,t)=>(t.active_installs||0)-(e.active_installs||0)),t}addScreenshotUrls(e){for(const t of e)if(t.slug){t.screenshots=[];for(let e=1;e<=10;e++)t.screenshots.push({id:e,url:`https://ps.w.org/${t.slug}/assets/screenshot-${e}.png`});t.primaryScreenshot=t.screenshots[0]?.url,t.currentScreenshotIndex=0}}async pluginHasScreenshots(e){return!!e.slug&&(this.state.screenshotCache.has(e.slug)?this.state.screenshotCache.get(e.slug):new Promise(t=>{const s=new Image,i=setTimeout(()=>{s.onload=null,s.onerror=null,this.state.screenshotCache.set(e.slug,!1),t(!1)},2e3);s.onload=()=>{clearTimeout(i),this.state.screenshotCache.set(e.slug,!0),t(!0)},s.onerror=()=>{clearTimeout(i),this.state.screenshotCache.set(e.slug,!1),t(!1)},s.src=`https://ps.w.org/${e.slug}/assets/screenshot-1.png`}))}async filterPluginsWithScreenshots(e){if(!e||0===e.length)return[];const t=[],s=[];for(let t=0;t<e.length;t+=3)s.push(e.slice(t,t+3));for(const e of s){const i=e.map(async e=>e.slug&&await this.pluginHasScreenshots(e)?e:null);(await Promise.allSettled(i)).forEach(e=>{"fulfilled"===e.status&&e.value&&t.push(e.value)}),s.indexOf(e)<s.length-1&&await new Promise(e=>setTimeout(e,150))}return console.log(`Filtered ${e.length} plugins down to ${t.length} with screenshots`),t}async applyScreenshotFilter(){this.state.onlyWithScreenshots&&0!==this.state.plugins.length&&(this.state.plugins=await this.filterPluginsWithScreenshots(this.state.plugins))}setLoading(e){this.state.isLoading=e,e?(this.elements.loading.style.display="block",this.elements.grid.style.opacity="0.6"):(this.elements.loading.style.display="none",this.elements.grid.style.opacity="1")}updateLoadMoreButton(){this.state.hasMorePages&&this.state.plugins.length>0?(this.elements.loadMoreContainer.style.display="block",this.elements.loadMoreButton.parentNode.style.display="inline-block",this.elements.loadMoreButton.textContent="Load More Plugins",this.elements.loadMoreButton.disabled=!1):this.elements.loadMoreContainer.style.display="none"}updateResultsInfo(){if(this.state.plugins.length>0){this.elements.resultsInfo.style.display="flex";let e=`Showing ${this.state.plugins.length.toLocaleString()} plugin${1!==this.state.plugins.length?"s":""}`;this.state.onlyWithScreenshots&&(e+=" with screenshots"),this.state.hasMorePages&&!this.state.onlyWithScreenshots&&(e+=` (${this.state.totalResults.toLocaleString()} total available)`),this.elements.resultsCount.textContent=e}else this.elements.resultsInfo.style.display="none"}isHiddenGem(e){const t=e.rating&&e.rating>=80,s=!e.active_installs||e.active_installs<1e4,i=e.last_updated&&new Date(e.last_updated)>new Date(Date.now()-31536e6);return t&&s&&i}createScreenshotSlider(e,t){const s=this.createElement("div",{class:"wps-screenshot-slider"});if(!e.screenshots||0===e.screenshots.length){const e=this.createElement("div",{class:"wps-no-screenshot"});return e.innerHTML='<span class="dashicons dashicons-format-image"></span><span>No screenshots available</span>',s.appendChild(e),s}return this.buildScreenshotSlider(s,e,e.screenshots,t),s}buildScreenshotSlider(e,t,s,i){const n=t.currentScreenshotIndex||0,l=this.createElement("div",{class:"wps-main-screenshot"}),a=this.createElement("img",{src:s[n]?.url||s[0]?.url,alt:`${this.sanitizeAndDecodeText(t.name)} screenshot`,loading:"lazy"});if(a.addEventListener("error",e=>{l.innerHTML='<div class="wps-no-screenshot"><span class="dashicons dashicons-format-image"></span><span>No screenshots available</span></div>'}),a.addEventListener("click",e=>{e.stopPropagation(),e.preventDefault();try{this.openLightbox(t,t.currentScreenshotIndex||0)}catch(e){}}),l.appendChild(a),e.appendChild(l),s.length>1){const i=this.createElement("div",{class:"wps-screenshot-thumbs"});s.slice(0,5).forEach((e,l)=>{const r=this.createElement("div",{class:"wps-screenshot-thumb "+(l===n?"active":""),"data-index":l,tabindex:"0","aria-label":`Screenshot ${l+1}`}),o=this.createElement("img",{src:e.url,alt:`Screenshot ${e.id}`,loading:"lazy"});o.addEventListener("error",e=>{e.target.parentNode.style.display="none"}),r.addEventListener("click",e=>{e.stopPropagation(),e.preventDefault();try{this.goToScreenshot(t,s,a,l),this.updateThumbnailHighlight(i,l),this.openLightbox(t,l)}catch(e){console.error("Error opening lightbox from thumbnail:",e)}}),r.addEventListener("keydown",e=>{if("Enter"===e.key||" "===e.key){e.preventDefault(),e.stopPropagation();try{this.goToScreenshot(t,s,a,l),this.updateThumbnailHighlight(i,l),this.openLightbox(t,l)}catch(e){console.error("Error opening lightbox from keyboard:",e)}}}),r.appendChild(o),i.appendChild(r)}),e.appendChild(i)}}goToScreenshot(e,t,s,i){i<0||i>=t.length||(e.currentScreenshotIndex=i,s.src=t[i].url,s.alt=`${this.sanitizeAndDecodeText(e.name)} screenshot ${i+1}`)}updateThumbnailHighlight(e,t){e.querySelectorAll(".wps-screenshot-thumb").forEach((e,s)=>{s===t?e.classList.add("active"):e.classList.remove("active")})}renderResults(e=!1){if(e||(this.elements.grid.innerHTML=""),0===this.state.plugins.length&&!e){const e=this.createElement("div",{class:"wps-no-results"});return this.state.searchTerm||this.hasActiveFilters()?e.innerHTML='\n\t\t\t\t\t<p>No plugins found matching your criteria.</p>\n\t\t\t\t\t<div class="wps-search-suggestion">\n\t\t\t\t\t\t<p>Try:</p>\n\t\t\t\t\t\t<ul>\n\t\t\t\t\t\t\t<li>Using different keywords</li>\n\t\t\t\t\t\t\t<li>Reducing filter restrictions</li>\n\t\t\t\t\t\t\t<li>Searching for <strong>"performance"</strong>, <strong>"security"</strong>, or <strong>"forms"</strong></li>\n\t\t\t\t\t\t</ul>\n\t\t\t\t\t</div>\n\t\t\t\t':e.textContent="No plugins found.",void this.elements.grid.appendChild(e)}(e?this.state.plugins.slice(-this.state.resultsPerPage):this.state.plugins).forEach((t,s)=>{const i=e?this.state.plugins.length-this.state.resultsPerPage+s:s,n=this.renderPluginItem(t,i);n&&this.elements.grid.appendChild(n)})}hasActiveFilters(){return this.state.searchTerm||"all"!==this.state.category||this.state.minRating>0||null!==this.state.maxInstalls||this.state.onlyWithScreenshots||this.state.sortBy!==(this.attributes.defaultSort||"popular")}renderPluginItem(e,t){if(!e||!e.name)return null;const s=this.isHiddenGem(e),i=this.createElement("div",{class:"wps-plugin-item "+(s?"wps-hidden-gem":""),tabindex:"0"}),n=this.createElement("div",{class:"wps-plugin-info"}),l=this.createElement("h3",{class:"wps-plugin-title"},this.sanitizeAndDecodeText(e.name));if(n.appendChild(l),e.short_description){const t=this.createElement("p",{class:"wps-plugin-description",style:"font-size: 0.9rem; color: #e0e0e0; line-height: 1.4; margin: 0.5rem 0 1rem; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;"},this.sanitizeAndDecodeText(e.short_description));n.appendChild(t)}const a=this.createElement("div",{class:"wps-plugin-meta"});if(e.rating){const t=Math.round(e.rating/20),s="★".repeat(t)+"☆".repeat(5-t),i=this.createElement("div",{class:"wps-plugin-rating"});i.innerHTML=`<span class="wps-rating-stars">${s}</span> <span class="wps-rating-text">(${e.num_ratings||0})</span>`,a.appendChild(i)}if(e.active_installs){const t=this.createElement("div",{class:"wps-plugin-installs"},`${e.active_installs.toLocaleString()}+ installs`);a.appendChild(t)}n.appendChild(a),i.appendChild(n);const r=this.createScreenshotSlider(e,t);return i.appendChild(r),i.addEventListener("click",t=>{if(!t.target.closest(".wps-screenshot-thumb, .wps-main-screenshot img")&&e.slug){const t=`https://wordpress.org/plugins/${encodeURIComponent(e.slug)}/`;window.open(t,"_blank","noopener,noreferrer")}}),i}renderError(e){this.elements.grid.innerHTML="";const t=this.createElement("div",{class:"wps-error"});t.innerHTML=`\n\t\t\t<h3>Error</h3>\n\t\t\t<p>${this.sanitizeInput(e)}</p>\n\t\t`;const s=this.createButton("Try Again",()=>this.performSearch());t.appendChild(s.container),this.elements.grid.appendChild(t)}}})();